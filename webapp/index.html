<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineBot ¬∑ Plataforma de Pel√≠culas</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #f1f5f9;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 30px 50px -15px rgba(0, 150, 255, 0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 40px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 25px -5px #8b5cf6;
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .plan-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 24px;
        }
        .plan-card.clasico {
            border-top: 4px solid #60a5fa;
        }
        .plan-card.premium {
            border-top: 4px solid #fbbf24;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold bg-gradient-to-r from-blue-400 to-purple-400 text-transparent bg-clip-text">
                üé¨ CineBot
            </h1>
            <div id="userDisplay" class="glass-card px-6 py-3 text-sm">
                <i class="fas fa-spinner fa-pulse mr-2"></i>Cargando...
            </div>
        </div>

        <!-- Contenido principal -->
        <div id="mainContent" class="space-y-8">
            <!-- El JS llenar√° esto -->
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const urlParams = new URLSearchParams(window.location.search);
        const TELEGRAM_ID = urlParams.get('tg_id');

        let usuario = null;
        let solicitudesPendientes = [];

        // ========== FUNCIONES ==========
        async function identificarUsuario() {
            if (!TELEGRAM_ID) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="glass-card p-8 text-center max-w-md mx-auto">
                        <i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4"></i>
                        <h2 class="text-2xl font-bold mb-2">No se pudo identificar</h2>
                        <p class="mb-6">Para usar la webapp, √°brela desde el bot de Telegram.</p>
                        <a href="https://t.me/your_bot_username" target="_blank" class="btn-primary inline-block">Ir al bot</a>
                    </div>
                `;
                return;
            }

            try {
                const res = await fetch(API_BASE + '/api/user-status', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({telegram_id: TELEGRAM_ID})
                });
                const data = await res.json();
                usuario = { id: TELEGRAM_ID, ...data };
                actualizarUI();
            } catch (e) {
                console.error(e);
                document.getElementById('mainContent').innerHTML = '<p class="glass-card p-8 text-center">Error de conexi√≥n</p>';
            }
        }

        function actualizarUI() {
            const userDisplay = document.getElementById('userDisplay');
            if (usuario.activo) {
                userDisplay.innerHTML = `
                    <i class="fas fa-check-circle text-green-400 mr-2"></i>
                    <span class="font-medium">${usuario.plan === 'clasico' ? '‚öúÔ∏è Cl√°sico' : 'üíé Premium'}</span>
                    <span class="badge ml-2">${new Date(usuario.expiracion).toLocaleDateString()}</span>
                `;
            } else {
                userDisplay.innerHTML = `
                    <i class="fas fa-clock text-yellow-400 mr-2"></i>
                    <span>Suscripci√≥n inactiva</span>
                `;
            }

            if (usuario.es_admin) {
                mostrarPanelAdmin();
            } else if (usuario.activo) {
                mostrarCatalogo();
            } else {
                mostrarPlanes();
            }
        }

        function mostrarPlanes() {
            document.getElementById('mainContent').innerHTML = `
                <div class="glass-card p-8">
                    <h2 class="text-3xl font-bold mb-8 text-center">Elige tu plan</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Plan Cl√°sico -->
                        <div class="plan-card clasico">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-4xl">‚öúÔ∏è</span>
                                <h3 class="text-2xl font-bold">Cl√°sico</h3>
                            </div>
                            <ul class="space-y-3 mb-6">
                                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-400"></i> Cat√°logo completo</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-400"></i> Visualizaci√≥n sin l√≠mites</li>
                                <li class="flex items-center gap-2"><i class="fas fa-times-circle text-red-400"></i> No reenviar/guardar</li>
                            </ul>
                            <div class="bg-white/10 rounded-xl p-4 mb-4">
                                <p class="text-sm opacity-70">üí≥ Tarjeta: <span class="font-mono">200 CUP</span></p>
                                <p class="text-sm opacity-70">üì± Saldo: <span class="font-mono">120 CUP</span></p>
                            </div>
                            <button onclick="mostrarFormPago('clasico')" class="btn-primary w-full">Seleccionar</button>
                        </div>
                        <!-- Plan Premium -->
                        <div class="plan-card premium">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-4xl">üíé</span>
                                <h3 class="text-2xl font-bold">Premium</h3>
                            </div>
                            <ul class="space-y-3 mb-6">
                                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-400"></i> Todo lo del plan Cl√°sico</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-400"></i> Reenv√≠o y guardado</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-400"></i> Prioridad en solicitudes</li>
                            </ul>
                            <div class="bg-white/10 rounded-xl p-4 mb-4">
                                <p class="text-sm opacity-70">üí≥ Tarjeta: <span class="font-mono">350 CUP</span></p>
                                <p class="text-sm opacity-70">üì± Saldo: <span class="font-mono">200 CUP</span></p>
                            </div>
                            <button onclick="mostrarFormPago('premium')" class="btn-primary w-full">Seleccionar</button>
                        </div>
                    </div>
                    <div id="formPagoContainer" class="mt-8"></div>
                </div>
            `;
        }

        function mostrarFormPago(plan) {
            const container = document.getElementById('formPagoContainer');
            container.innerHTML = `
                <div class="glass-card p-6 max-w-2xl mx-auto">
                    <h3 class="text-2xl font-bold mb-6">Pago plan ${plan === 'clasico' ? '‚öúÔ∏è Cl√°sico' : 'üíé Premium'}</h3>
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-white/10 rounded-xl p-4">
                            <h4 class="font-bold mb-2"><i class="fas fa-credit-card mr-2"></i>Transferencia</h4>
                            <p class="font-mono text-sm break-all">9248-1299-7027-1730</p>
                            <p class="text-xs mt-1">Confirmaci√≥n: 63806513</p>
                        </div>
                        <div class="bg-white/10 rounded-xl p-4">
                            <h4 class="font-bold mb-2"><i class="fas fa-mobile-alt mr-2"></i>Saldo m√≥vil</h4>
                            <p class="font-mono text-sm">63806513</p>
                            <p class="text-xs mt-1">Monto: ${plan === 'clasico' ? '120' : '200'} CUP</p>
                        </div>
                    </div>
                    <select id="metodoPago" class="w-full p-3 rounded-xl bg-white/10 border border-white/20 mb-4">
                        <option value="tarjeta">Transferencia bancaria</option>
                        <option value="saldo">Saldo m√≥vil</option>
                    </select>
                    <input type="file" id="captura" accept="image/*" class="w-full p-2 rounded-xl bg-white/10 border border-white/20 mb-4">
                    <button onclick="enviarCaptura('${plan}')" class="btn-primary w-full">
                        <i class="fas fa-upload mr-2"></i>Enviar comprobante
                    </button>
                </div>
            `;
        }

        async function enviarCaptura(plan) {
            const file = document.getElementById('captura').files[0];
            const metodo = document.getElementById('metodoPago').value;
            if (!file) return alert('Selecciona una captura');
            const reader = new FileReader();
            reader.onload = async function(e) {
                const res = await fetch(API_BASE + '/api/submit-payment', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegram_id: TELEGRAM_ID,
                        plan: plan,
                        metodo: metodo,
                        imagen: e.target.result
                    })
                });
                if (res.ok) {
                    alert('‚úÖ Solicitud enviada. Espera la aprobaci√≥n del administrador.');
                    document.getElementById('formPagoContainer').innerHTML = '';
                } else {
                    alert('‚ùå Error al enviar');
                }
            };
            reader.readAsDataURL(file);
        }

        function mostrarCatalogo() {
            document.getElementById('mainContent').innerHTML = `
                <div class="glass-card p-8">
                    <h2 class="text-3xl font-bold mb-6">üé• Cat√°logo de pel√≠culas</h2>
                    <div class="flex gap-4 mb-6">
                        <input type="text" id="buscador" placeholder="Buscar por t√≠tulo..." 
                               class="flex-1 p-3 rounded-xl bg-white/10 border border-white/20">
                        <button onclick="buscarPeliculas(1)" class="btn-primary">Buscar</button>
                    </div>
                    <div id="catalogoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    <div id="paginacion" class="flex justify-center gap-2 mt-6"></div>
                </div>
            `;
            buscarPeliculas(1);
        }

        async function buscarPeliculas(page = 1) {
            const search = document.getElementById('buscador')?.value || '';
            const res = await fetch(API_BASE + '/api/catalogo', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ telegram_id: TELEGRAM_ID, page, search })
            });
            if (!res.ok) return alert('No tienes suscripci√≥n activa');
            const data = await res.json();
            const grid = document.getElementById('catalogoGrid');
            if (!data.data.length) {
                grid.innerHTML = '<p class="text-center col-span-full">No hay pel√≠culas</p>';
                return;
            }
            grid.innerHTML = data.data.map(p => `
                <div class="glass-card p-4 cursor-pointer hover:scale-105 transition" onclick="solicitarPelicula('${p.id}')">
                    <i class="fas fa-film text-3xl mb-2 text-blue-400"></i>
                    <h3 class="font-bold">${p.titulo}</h3>
                    <p class="text-xs opacity-60">ID: ${p.id.substring(0,8)}</p>
                </div>
            `).join('');
            const totalPages = Math.ceil(data.total / 10);
            const pag = document.getElementById('paginacion');
            pag.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                pag.innerHTML += `<button onclick="buscarPeliculas(${i})" class="btn-secondary ${i === page ? 'bg-white/20' : ''}">${i}</button>`;
            }
        }

        async function solicitarPelicula(id) {
            if (!confirm('¬øEnviar esta pel√≠cula a tu Telegram?')) return;
            const res = await fetch(API_BASE + '/api/request-movie', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ telegram_id: TELEGRAM_ID, pelicula_id: id })
            });
            if (res.ok) alert('‚úÖ Pel√≠cula enviada a tu chat');
            else alert('‚ùå Error al enviar');
        }

        // ========== PANEL ADMIN ==========
        async function mostrarPanelAdmin() {
            document.getElementById('mainContent').innerHTML = `
                <div class="glass-card p-8">
                    <h2 class="text-3xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-crown text-yellow-400"></i> Panel de Administraci√≥n
                    </h2>
                    <div class="flex gap-4 mb-6">
                        <button onclick="cargarSolicitudes()" class="btn-secondary"><i class="fas fa-clock mr-2"></i>Solicitudes</button>
                        <button onclick="cargarUsuarios()" class="btn-secondary"><i class="fas fa-users mr-2"></i>Usuarios</button>
                    </div>
                    <div id="adminContent" class="space-y-4"></div>
                </div>
            `;
            cargarSolicitudes();
        }

        async function cargarSolicitudes() {
            const res = await fetch(API_BASE + '/api/pending-requests', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ telegram_id: TELEGRAM_ID })
            });
            if (!res.ok) return alert('No autorizado');
            const solicitudes = await res.json();
            const adminDiv = document.getElementById('adminContent');
            if (!solicitudes.length) {
                adminDiv.innerHTML = '<p>No hay solicitudes pendientes.</p>';
                return;
            }
            adminDiv.innerHTML = solicitudes.map(s => `
                <div class="glass-card p-4">
                    <div class="flex flex-wrap gap-4 items-start justify-between">
                        <div>
                            <p><strong>Usuario:</strong> ${s.telegram_id}</p>
                            <p><strong>Plan:</strong> ${s.plan_solicitado}</p>
                            <p><strong>M√©todo:</strong> ${s.metodo_pago}</p>
                            <p><strong>Fecha:</strong> ${new Date(s.created_at).toLocaleString()}</p>
                        </div>
                        <img src="${s.captura_url}" class="h-24 rounded-lg">
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="aprobar('${s.id}')" class="btn-primary">Aprobar</button>
                        <button onclick="rechazar('${s.id}')" class="btn-secondary">Rechazar</button>
                    </div>
                </div>
            `).join('');
        }

        async function aprobar(id) {
            if (!confirm('¬øAprobar esta solicitud?')) return;
            await fetch(API_BASE + '/api/approve-request', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ admin_id: TELEGRAM_ID, solicitud_id: id })
            });
            cargarSolicitudes();
        }

        async function rechazar(id) {
            const motivo = prompt('Motivo del rechazo:');
            if (!motivo) return;
            await fetch(API_BASE + '/api/reject-request', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ admin_id: TELEGRAM_ID, solicitud_id: id, motivo })
            });
            cargarSolicitudes();
        }

        async function cargarUsuarios() {
            // Implementaci√≥n b√°sica (puedes expandir)
            alert('Funcionalidad de usuarios en desarrollo');
        }

        // Iniciar
        identificarUsuario();
    </script>
</body>
</html>
